<!DOCTYPE html>
<html>
<head>
	<title>Edit settings</title>
	<link rel="stylesheet" type="text/css" href="/resources/style.css">
	<script src="/resources/jQuery.js">//jQuery</script>
	<script src="/resources/gui.js"></script>
	<script>
		//// AUTHENTICATE /////////////////////////////////////////////////////////////////////////

		window.onLoad = check();

		function check() {
			if(document.cookie.toString().length == 0 || document.cookie.toString() == "null") {
				if(confirm("You aren't logged in, and you won't be able to access this page until you log in. Log in now?")) {
					window.location = "/login.html";
				}
				else {
					window.location = "/";
				}
			}
			else {
				var name = document.cookie.split(",")[0];
				var password = document.cookie.split(",")[1];
				jQuery.post("/login", {
					username: name,
					pass: password,
					encrypted: true
				}, function(result) {
					switch(result.split(",")[0]) {
						case "complete":
						break;
						case "password":
							if(confirm("Your password/username is incorrect, and you won't\n" +
								"be able to access this page until you log in.\nLog in now?")) {
								window.location = "/login.html";
							}
							else {
								window.location = "/";
							}
						break;
						case "username":
							if(confirm("Your username credentials doesn't exist, and you won't\n" +
								"be able to access this page until you log in.\nLog in now?")) {
								window.location = "/login.html";
							}
							else {
								window.location = "/";
							}
						break;

						default:
							alert("A server error occured. When you press \"OK\" the page will be refreshed." +
								"\nError: " + result);
							window.location.reload();
						break;
					}
				});
			}
		}

		function logOut() {
			document.cookie = "; path=/prefs.html";
			document.cookie = "; path=/login.html";
			window.location = "/login.html";
		}

		//// SAVE DATA TO THE SERVER //////////////////////////////////////////////////////////////

		function postPrefs() {
			var name = document.cookie.split(",")[0];
			var password = document.cookie.split(",")[1];
			var updatemails = document.getElementById("mailing").checked;
			var devlogs = document.getElementById("devlogs").checked;

			jQuery.post("/save", {
				username: name,
				pass: password,
				mails: updatemails,
				logs: devlogs,
				encrypted: true
			}, function(result) {
				switch(result.split(",")[0]) {
					case "complete":
						window.location.reload();
					break;
					case "password":
						if(confirm("Your password/username is incorrect, and you won't\n" +
							"be able to access this page until you log in\n. Log in now?")) {
							window.location = "/login.html";
						}
						else {
							window.location = "/";
						}
					break;
					case "username":
						if(confirm("Your username credential doesn't exist, and you won't\n" +
							"be able to access this page until you log in\n. Log in now?")) {
							window.location = "/login.html";
						}
						else {
							window.location = "/";
						}
					break;

					default:
						alert("A server error occured. When you press \"OK\" the page will be refreshed." +
							"\nError: " + result);
						window.location.reload();
					break;
				}
			});
		}

		function postPW() {
			var name = document.cookie.split(",")[0];
			var password = document.getElementById("oldPW").value;
			var newPass = document.getElementById("newPW1").value;

			jQuery.post("/newPass", {
				username: name,
				pass: password,
				olga: newPass,
				encrypted: false
			}, function(result) {
				switch(result.split(",")[0]) {
					case "complete":
						password = result.split(",")[1];
						document.cookie = name + "," + password + "; path=/prefs.html";
						window.location.reload();
					break;
					case "verify":
						if(confirm("Your username isn't verified, and you won't\n" +
							"be able to access this page until you verify your email.\nRefresh now?")) {
							window.location.reload();
						}
						else {
							window.location = "/";
						}
					break;
					case "password":
						logOut();
						if(confirm("Your password/username is incorrect, and you won't\n" +
							"be able to access this page until you log in.\nLog in now?")) {
							window.location = "/login.html";
						}
						else {
							window.location = "/";
						}
					break;
					case "username":
						logOut();
						if(confirm("Your username credentials doesn't exist, and you won't\n" +
							"be able to access this page until you log in.\nLog in now?")) {
							window.location = "/login.html";
						}
						else {
							window.location = "/";
						}
					break;

					default:
						alert("A server error occured. When you press \"OK\" the page will be refreshed." +
							"\nError: " + result);
						window.location.reload();
					break;
				}
			});
		}

		function checkPW() {
			var pw1 = document.getElementById("newPW1").value;
			var pw2 = document.getElementById("newPW2").value;
			if (pw1 == pw2) {
				if(pw1.indexOf(",") != -1
					|| pw1.indexOf(":") != -1
					|| pw1.indexOf(" ") != -1
					|| pw1.indexOf("'") != -1
					|| pw1.indexOf("*") != -1
					|| pw1.indexOf("&") != -1
					|| pw1.indexOf("=") != -1
					|| pw1.indexOf("\\") != -1
					|| pw1.indexOf("\"") != -1) { //check for sh*t
					document.getElementById("warn").innerHTML = "Invalid password.";
					document.getElementById("warn").style.opacity = "1";
					document.getElementById("submit").disabled = true;
				}
				else {
					if (pw1.length > 6) {
						document.getElementById("warn").style.opacity = "0";
						document.getElementById("submit").disabled = false;
					}
					else {
						document.getElementById("warn").innerHTML = "Please use a password with more characters. (> 6)";
						document.getElementById("warn").style.opacity = "1";
						document.getElementById("submit").disabled = true;
					}
				}
			}
			else {
				document.getElementById("warn").innerHTML = "Passwords don't match!";
				document.getElementById("warn").style.opacity = "1";
				document.getElementById("submit").disabled = true;
			}
		}

		function changePW() {
			var name = document.cookie.split(",")[0];
			var oldPass = document.getElementById("oldPW").value;
			var newPass = document.getElementById("newPW1").value;
			jQuery.post("/newPass", {username: name, pass: oldPass, new: newPass, encrypted: true}, function(result) {
			console.log(result);
			});
		}
	</script>
</head>
<body>
	<div class="topMenu"> <!--The top bar thing-->
		<img src="./images/navicon.png" id="navicon" onclick="openNav()""><!--The menu symbol-->
	</div>
	<a href="javascript:window.open('http://leppu.tumblr.com/');"><img id="tumblr" src="./images/tumblr.png"></a> <!--Leppu's Tumblr-->
	<a href="javascript:window.open('https://twitter.com/petra_nordlund');"><img id="twitter" src="./images/twitter.png"></a> <!--Leppu's Twitter-->
	<a href="javascript:window.open('http://www.praguerace.com/rss.php');"><img id="rss" src="./images/rss.png"></a> <!--Hiveworks's RSS--> <!--TBH I have no idea about how RSS works or how to use it-->
	<a href="javascript:window.open('https://www.patreon.com/praguerace');"><img id="patreon" src="./images/patreon.png"></a> <!--Leppu's Patreon--> <!--Please go donate!-->

	<div id="vertiBar"></div> <!--The side bar thing-->

	<img id="logo" src="./images/doofR.png" onclick="javascript:window.location = '/'"> <!--The werewolf face-->

	<div class="sidenav" id="sidepanel"> <!--The sidenav itself-->
		<br><br><br><br><br><br><br><br> <!--Highly sophisticated methods of spacing-->
		<h1><a href="javascript:void(0)" id="closebtn" onclick="closeNav()">&times;</a></h1>
		<h2><a href="/index.html">Back to the home page</a></h2>
		<br><br><br><br>
		<h2><a href="javascript:window.open('http://www.praguerace.com/');">Read the comic!</a></h2>
		<br><br><br><br>
		<h2><a href="/about">About this</a></h2>
	</div>

	<div class="notMenu">
		<br><br>
		<form action="javascript:postPrefs();">
			<input type="checkbox" name="updates" id="mailing">
			<label for="updates">Receive emails when Prague Race updates</label>
			<br><br>
			<input type="checkbox" name="devlogs" id="devlogs">
			<label for="devlogs">Receive developer updates from the website</label>
			<br><br><br>
			<input type="submit" value="Submit">
		</form>
		<br><br><br>
		<input type="button" value="Change password" onclick="togglePW()">
		&emsp;<input type="button" value="Log out" onclick="logOut()">
		<br><br><hr id="hr">
		<div id="passbar">
			<form action="javascript:postPW();" id="form">
				<br>
				<p>Old PW:</p><input class="passChange" type="password" id="oldPW" name="old" oninput="checkPW()">
				<br>
				<p>New PW:</p><input class="passChange" type="password" id="newPW1" name="new1" oninput="checkPW()">
				<br>
				<p>Confirm:</p><input class="passChange" type="password" id="newPW2" name="new2" oninput="checkPW()">
				<br><br><br>
				<input type="submit" id="submit" value="Save" disabled="true">
				<br><br>
			</form>
		<br>
		<div id="warn">Lorem ipsum yo</div>
		<br>
		</div>
	</div>
</body>
</html>