<!DOCTYPE html>
<html>
<meta charset="UTF-8">
<head>
	<title>Prague Race Updates</title>
	<link rel="stylesheet" type="text/css" href="/resources/style.css">
	<script src="/resources/jQuery.js">//jQuery</script>
	<script src="/resources/gui.js"></script>
	<script>
		var updateText;
		var lastCheckTime = 0;

		//// NOTIFICATIONS ////////////////////////////////////////////////////////////////////////

		document.addEventListener('DOMContentLoaded', function() { //ask for permissions
			if (Notification.permission !== "granted")
			 Notification.requestPermission(); //please OwO
		});

		function notify(image) {
			if (!Notification) {
				alert("Prague Race updated!\nDesktop notifications aren't available in your browser.");
				return;
			}

			if (Notification.permission !== "granted"){ //if you didn't get permission
				Notification.requestPermission();
			}
			else { //if you did though
				console.log("UPDATE!");
				var notification = new Notification("Prague Race updated!", {
					icon: image,
					body: "We just noticed an update to Prague Race, you should go check it out!",
				});
				notification.onclick = function() {
					window.open("http://www.praguerace.com/");
					notification.close();      
				};
			}
		}

		//// ACTUAL "MECHANISM" ///////////////////////////////////////////////////////////////////

		window.onLoad = jQuery.get("/update.txt", function(data, status) { //init
			updateText = data;
			document.getElementById("lad").innerHTML = updateText.split(",")[0];
			document.getElementById("lat").innerHTML = updateText.split(",")[1];
			document.getElementById("spoiler").src = updateText.split(",")[2];
		});

		function check() {
			document.getElementById("status").innerHTML = "Checking for update...";
			jQuery.get("/update.txt", function(data, status) {
				if(data == updateText) {}
				else { //yes update
					document.getElementById("status").innerHTML = "Update!";
					document.getElementById("lad").innerHTML = updateText.split(",")[0];
					document.getElementById("lat").innerHTML = updateText.split(",")[1];
					document.getElementById("spoiler").src = updateText.split(",")[2];
					notify(updateText.split(",")[2]);
				}
				updateText = data;
			});
		}

		//// TIMER ////////////////////////////////////////////////////////////////////////////////

		window.onLoad = setInterval(function() {
			document.getElementById("status").innerHTML = "Checked " + lastCheckTime + " seconds ago."
			if (lastCheckTime == 30){ //reset the check loop
				check(); //refresh
				lastCheckTime = 0;
			}
			lastCheckTime ++;
		}, 1000);
	</script>
</head>
<body>
	<div class="topMenu"> <!--The top bar thing-->
		<img src="./images/navicon.png" id="navicon" onclick="openNav()""><!--The menu symbol-->
	</div>

	<a href="javascript:window.open('http://leppu.tumblr.com/');"><img id="tumblr" src="./images/tumblr.png"></a> <!--Leppu's Tumblr-->
	<a href="javascript:window.open('https://twitter.com/petra_nordlund');"><img id="twitter" src="./images/twitter.png"></a> <!--Leppu's Twitter-->
	<a href="javascript:window.open('http://www.praguerace.com/rss.php');"><img id="rss" src="./images/rss.png"></a> <!--Hiveworks's RSS--> <!--TBH I have no idea about how RSS works or how to use it-->
	<a href="javascript:window.open('https://www.patreon.com/praguerace');"><img id="patreon" src="./images/patreon.png"></a> <!--Leppu's Patreon--> <!--Please go donate!-->

	<div id="vertiBar"></div> <!--The side bar thing-->

	<img id="logo" src="./images/doofR.png" onclick="javascript:location.reload()"> <!--The werewolf face-->

	<div class="sidenav" id="sidepanel"> <!--The sidenav itself-->
		<br><br><br><br> <!--Highly sophisticated methods of spacing-->
		<h1><a href="javascript:void(0)" id="closebtn" onclick="closeNav()">&times;</a></h1>
		<h1><a href="/subscribe.html">Subscribe to updates</a></h1>
		<br><br><br>
		<h1><a href="/login.html">Modify your settings</a></h1>
		<br><br><br>
		<h1><a href="javascript:window.open('http://www.praguerace.com/');">Read the comic!</a></h1>
		<br><br><br>
		<h1><a href="/about.html">About this</a></h1>
	</div>

	<div id="spoilers"> <!--The last page spoiler thing-->
		<h1><a href="javascript:void(0)"onclick="closeSpoiler()">&times;</a></h1>
		<img style="color: white;" id="spoiler" alt="Couldn't find the panel. Error!">
	</div>

	<div class="notMenu"> <!--The body of the page-->
		<div <table border="0" class="table"> <!--For organisation-->
			<tr>
				<td><h1>Last updated on:</h1></td>
				<td><h1 id="lad">No data yet.</h1></td> <!--LAD = last update date-->
			</tr>
			<br>
			<tr>
				<td><h1>Last update panel:</h1></td>
				<td><h1><a href="javascript:openSpoiler();">Show</a></h1></td>
			</tr>
			<br>
			<tr>
				<td><h1>Last update title:</h1></td>
				<td><h1 id="lat">No data yet.</h1></td> <!--LAT = last update title-->
			</tr>
			<br>
			<tr>
				<td><h1>Current status:</h1></td>
				<td><h1 id="status">Waiting for start.</h1></td>
			</tr>
		</table>
	</div>
</body>
</html>